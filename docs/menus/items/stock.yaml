openapi: 3.0.0
paths:
  # ============================================
  # POST /items/stock/daily-reset
  # ============================================
  /menu/items/stock/daily-reset:
    post:
      tags:
        - Menu Items - Stock
      summary: Register initial daily stock
      description: |
        Initializes stock quantities for multiple menu items at the start of the business day.

        This operation is typically performed by administrators or managers when:
        - Opening operations for the day
        - Completing kitchen preparation
        - Recording production quantities

        **Key Features:**
        - Batch operation for multiple items
        - Sets both stockQuantity and initialStock
        - Marks all items as available
        - Creates audit trail entries
        - Atomic transaction (all or nothing)

        **Business Rules:**
        - Only TRACKED inventory items can have stock reset
        - UNLIMITED items will be rejected
        - All items must exist in database
        - Previous stock values are preserved in history
        - Low stock alerts are configured per item

        **Required Permissions:**
        - ADMIN or MANAGER role

      security:
        - BearerAuth: []

      requestBody:
        required: true
        description: Array of items with their initial stock quantities
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DailyStockResetRequest"
            examples:
              singleItem:
                summary: Reset stock for a single item
                value:
                  items:
                    - itemId: 1
                      quantity: 30
                      lowStockAlert: 5

              multipleItems:
                summary: Reset stock for multiple items
                value:
                  items:
                    - itemId: 1
                      quantity: 30
                      lowStockAlert: 5
                    - itemId: 2
                      quantity: 25
                      lowStockAlert: 3
                    - itemId: 5
                      quantity: 40
                      lowStockAlert: 10

              withoutAlerts:
                summary: Reset without custom alerts (uses defaults)
                value:
                  items:
                    - itemId: 1
                      quantity: 30
                    - itemId: 2
                      quantity: 25

              zeroStock:
                summary: Reset with zero stock (valid for preparation tracking)
                value:
                  items:
                    - itemId: 1
                      quantity: 0
                      lowStockAlert: 5

      responses:
        200:
          description: Stock reset completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponseNoData"
              example:
                success: true
                message: "Daily stock reset successfully"

        400:
          description: Bad Request - Validation errors or business rule violations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                emptyArray:
                  summary: Empty items array
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "items"
                        message: "At least one item must be provided"

                negativeQuantity:
                  summary: Negative quantity provided
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "quantity"
                        message: "Quantity must be 0 or greater"

                invalidItemId:
                  summary: Invalid item ID format
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "itemId"
                        message: "Item ID must be positive"

                unlimitedItems:
                  summary: Attempting to reset UNLIMITED items
                  value:
                    success: false
                    status: 400
                    message: "Only TRACKED items can have stock reset"
                    code: "INVALID_INVENTORY_TYPE"

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to perform stock operations"
                code: "FORBIDDEN"

        404:
          description: Not Found - One or more items don't exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 404
                message: "Items not found: 1, 5, 8"
                code: "ITEMS_NOT_FOUND"

  # ============================================
  # POST /items/{id}/stock/add
  # ============================================
  /menu/items/{id}/stock/add:
    post:
      tags:
        - Menu Items - Stock
      summary: Add stock manually
      description: |
        Manually adds stock to a specific menu item.

        This operation is used for:
        - Mid-day production additions
        - Additional prep due to high demand
        - Inventory corrections (count adjustments)
        - Stock replenishment during service

        **Key Features:**
        - Adds to current stock quantity
        - Records reason for audit trail
        - Captures user ID automatically
        - Creates MANUAL_ADD adjustment record
        - Can make unavailable items available again

        **Business Rules:**
        - Only TRACKED inventory items can have stock added
        - UNLIMITED items will be rejected
        - Item must exist and not be deleted
        - Reason is mandatory for accountability

        **Required Permissions:**
        - ADMIN or MANAGER role

      security:
        - BearerAuth: []

      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
          description: Menu item identifier
          example: 1

      requestBody:
        required: true
        description: Stock addition details
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddStockRequest"
            examples:
              additionalProduction:
                summary: Additional mid-day production
                value:
                  quantity: 15
                  reason: "Additional mid-day production due to high demand"

              inventoryCorrection:
                summary: Inventory count correction
                value:
                  quantity: 5
                  reason: "Inventory correction after physical count"

              morningBatch:
                summary: Morning batch completed
                value:
                  quantity: 20
                  reason: "Second morning production batch completed"

      responses:
        200:
          description: Stock added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MenuItemResponse"
              example:
                success: true
                message: "Stock added successfully"
                data:
                  id: 1
                  categoryId: 2
                  name: "Bandeja Paisa"
                  description: "Traditional Colombian platter"
                  price: 25000.00
                  isExtra: false
                  isAvailable: true
                  imageUrl: "https://cloudinary.com/plaet/items/bandeja-paisa.jpg"
                  inventoryType: "TRACKED"
                  stockQuantity: 33
                  initialStock: 30
                  lowStockAlert: 5
                  autoMarkUnavailable: true
                  createdAt: "2025-01-15T10:00:00.000Z"
                  updatedAt: "2025-10-14T14:30:00.000Z"
                  deleted: false
                  deletedAt: null

        400:
          description: Bad Request - Validation or business rule errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidQuantity:
                  summary: Quantity is not positive
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "quantity"
                        message: "Quantity must be positive"

                missingReason:
                  summary: Reason not provided
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "reason"
                        message: "Reason must be at least 3 characters"

                unlimitedItem:
                  summary: Attempting to add stock to UNLIMITED item
                  value:
                    success: false
                    status: 400
                    message: "Cannot add stock to UNLIMITED items"
                    code: "INVALID_INVENTORY_TYPE"

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to manage stock"
                code: "FORBIDDEN"

        404:
          description: Not Found - Menu item doesn't exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 404
                message: "Menu Item ID 1 not found"
                code: "ID_NOT_FOUND"

  # ============================================
  # POST /items/{id}/stock/remove
  # ============================================
  menu/items/{id}/stock/remove:
    post:
      tags:
        - Menu Items - Stock
      summary: Remove stock manually
      description: |
        Manually removes stock from a specific menu item.

        This operation is used for:
        - Food spoilage tracking
        - Damaged items removal
        - Quality control removals
        - Dropped or spilled items
        - End-of-day waste recording

        **Key Features:**
        - Subtracts from current stock
        - Records reason for waste analysis
        - Captures user ID automatically
        - Creates MANUAL_REMOVE adjustment record
        - Can trigger item unavailability

        **Business Rules:**
        - Only TRACKED inventory items can have stock removed
        - UNLIMITED items will be rejected
        - Cannot remove more than current stock
        - Item must exist and not be deleted
        - If stock reaches 0, item may become unavailable

        **Required Permissions:**
        - ADMIN or MANAGER role

      security:
        - BearerAuth: []

      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
          description: Menu item identifier
          example: 1

      requestBody:
        required: true
        description: Stock removal details
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RemoveStockRequest"
            examples:
              spoilage:
                summary: Food spoilage
                value:
                  quantity: 3
                  reason: "Items spoiled due to temperature issues"

              damaged:
                summary: Damaged during service
                value:
                  quantity: 2
                  reason: "Dishes dropped during service - kitchen accident"

              qualityControl:
                summary: Quality control removal
                value:
                  quantity: 1
                  reason: "Quality standards not met - removed from service"

              wasteTracking:
                summary: End-of-day waste
                value:
                  quantity: 5
                  reason: "End-of-day waste - items not sold"

      responses:
        200:
          description: Stock removed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MenuItemResponse"
              example:
                success: true
                message: "Stock removed successfully"
                data:
                  id: 1
                  categoryId: 2
                  name: "Bandeja Paisa"
                  description: "Traditional Colombian platter"
                  price: 25000.00
                  isExtra: false
                  isAvailable: true
                  imageUrl: "https://cloudinary.com/plaet/items/bandeja-paisa.jpg"
                  inventoryType: "TRACKED"
                  stockQuantity: 15
                  initialStock: 30
                  lowStockAlert: 5
                  autoMarkUnavailable: true
                  createdAt: "2025-01-15T10:00:00.000Z"
                  updatedAt: "2025-10-14T15:00:00.000Z"
                  deleted: false
                  deletedAt: null

        400:
          description: Bad Request - Validation or business rule errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidQuantity:
                  summary: Quantity is not positive
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "quantity"
                        message: "Quantity must be positive"

                insufficientStock:
                  summary: Not enough stock to remove
                  value:
                    success: false
                    status: 400
                    message: "Insufficient stock to remove"
                    code: "INSUFFICIENT_STOCK"

                unlimitedItem:
                  summary: Attempting to remove from UNLIMITED item
                  value:
                    success: false
                    status: 400
                    message: "Cannot remove stock from UNLIMITED items"
                    code: "INVALID_INVENTORY_TYPE"

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to manage stock"
                code: "FORBIDDEN"

        404:
          description: Not Found - Menu item doesn't exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 404
                message: "Menu Item ID 1 not found"
                code: "ID_NOT_FOUND"

  # ============================================
  # GET /items/low-stock
  # ============================================
  /menu/items/low-stock:
    get:
      tags:
        - Menu Items - Stock
      summary: List items with low stock
      description: |
        Retrieves menu items that have reached or fallen below their low stock alert threshold.

        This endpoint helps with:
        - Proactive stock management
        - Preventing stockouts during service
        - Kitchen production planning
        - Manager notifications

        **Key Features:**
        - Returns items where: stockQuantity <= lowStockAlert
        - Only TRACKED inventory items included
        - Excludes soft-deleted items
        - No pagination (typically small result set)
        - Real-time accuracy

        **Business Rules:**
        - Each item has customizable lowStockAlert threshold
        - Default threshold is 5 units
        - Only applies to TRACKED items
        - UNLIMITED items never appear in results

        **Required Permissions:**
        - ADMIN, MANAGER, or WAITER role

      security:
        - BearerAuth: []

      responses:
        200:
          description: Low stock items retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MenuItemListResponse"
              example:
                success: true
                message: "Low stock items fetched successfully"
                data:
                  - id: 1
                    categoryId: 2
                    name: "Bandeja Paisa"
                    stockQuantity: 4
                    lowStockAlert: 5
                    inventoryType: "TRACKED"
                    isAvailable: true
                  - id: 5
                    categoryId: 3
                    name: "Ajiaco"
                    stockQuantity: 2
                    lowStockAlert: 5
                    inventoryType: "TRACKED"
                    isAvailable: true

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to view stock information"
                code: "FORBIDDEN"

  # ============================================
  # GET /items/out-of-stock
  # ============================================
  /menu/items/out-of-stock:
    get:
      tags:
        - Menu Items - Stock
      summary: List items that are out of stock
      description: |
        Retrieves menu items that have completely depleted their stock (stockQuantity = 0).

        Critical for:
        - Service staff to know what cannot be ordered
        - Kitchen production prioritization
        - Preventing order fulfillment errors
        - Dynamic menu adjustments

        **Key Features:**
        - Returns items with exactly 0 stock
        - Only TRACKED inventory items included
        - Includes both available and unavailable items
        - No pagination (typically small result set)
        - Real-time updates essential

        **Business Rules:**
        - Items with autoMarkUnavailable=true are automatically blocked
        - Out of stock items still appear in this list
        - Useful for production planning
        - Only applies to TRACKED items

        **Required Permissions:**
        - ADMIN, MANAGER, or WAITER role

      security:
        - BearerAuth: []

      responses:
        200:
          description: Out of stock items retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MenuItemListResponse"
              example:
                success: true
                message: "Out of stock items fetched successfully"
                data:
                  - id: 3
                    categoryId: 2
                    name: "Sancocho"
                    stockQuantity: 0
                    inventoryType: "TRACKED"
                    isAvailable: false
                    autoMarkUnavailable: true
                  - id: 7
                    categoryId: 4
                    name: "Lechona"
                    stockQuantity: 0
                    inventoryType: "TRACKED"
                    isAvailable: false
                    autoMarkUnavailable: true

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to view stock information"
                code: "FORBIDDEN"

  # ============================================
  # GET /items/{id}/stock/history
  # ============================================
  /menu/items/{id}/stock/history:
    get:
      tags:
        - Menu Items - Stock
      summary: Get stock adjustment history
      description: |
        Retrieves complete stock adjustment history for a specific menu item with pagination.

        This endpoint provides:
        - Complete audit trail of stock changes
        - User accountability tracking
        - Order-stock reconciliation
        - Waste tracking analysis

        **Key Features:**
        - Paginated results (newest first)
        - Complete adjustment details
        - User and order tracking
        - Configurable page size

        **Adjustment Types:**
        - DAILY_RESET: Daily stock initialization
        - MANUAL_ADD: Manual stock addition
        - MANUAL_REMOVE: Manual stock removal (waste, spoilage)
        - ORDER_DEDUCT: Stock deducted for order fulfillment
        - ORDER_CANCELLED: Stock restored from cancelled order

        **Required Permissions:**
        - ADMIN or MANAGER role

      security:
        - BearerAuth: []

      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
          description: Menu item identifier
          example: 1

        - in: query
          name: page
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            default: 1
          description: Page number
          example: 1

        - in: query
          name: limit
          required: false
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 100
            default: 20
          description: Records per page
          example: 20

      responses:
        200:
          description: Stock history retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StockHistoryResponse"
              example:
                success: true
                message: "Stock History fetched successfully"
                data:
                  data:
                    - id: "123e4567-e89b-12d3-a456-426614174001"
                      menuItemId: 1
                      adjustmentType: "MANUAL_ADD"
                      previousStock: 18
                      newStock: 33
                      quantity: 15
                      reason: "Additional mid-day production"
                      userId: "550e8400-e29b-41d4-a716-446655440001"
                      orderId: null
                      createdAt: "2025-10-14T14:30:00.000Z"
                    - id: "123e4567-e89b-12d3-a456-426614174002"
                      menuItemId: 1
                      adjustmentType: "ORDER_DEDUCT"
                      previousStock: 19
                      newStock: 18
                      quantity: -1
                      reason: "Order abc123"
                      userId: null
                      orderId: "abc123"
                      createdAt: "2025-10-14T13:15:00.000Z"
                    - id: "123e4567-e89b-12d3-a456-426614174003"
                      menuItemId: 1
                      adjustmentType: "DAILY_RESET"
                      previousStock: 0
                      newStock: 30
                      quantity: 30
                      reason: "Begin of the day"
                      userId: null
                      orderId: null
                      createdAt: "2025-10-14T08:00:00.000Z"
                  meta:
                    total: 45
                    page: 1
                    limit: 20
                    totalPages: 3

        400:
          description: Bad Request - Invalid parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidPage:
                  summary: Invalid page number
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "page"
                        message: "Page must be positive"

                invalidLimit:
                  summary: Limit exceeds maximum
                  value:
                    success: false
                    status: 400
                    message: "Validation failed"
                    code: "VALIDATION_ERROR"
                    errors:
                      - field: "limit"
                        message: "Limit cannot exceed 100"

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks required permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "You don't have permission to view audit information"
                code: "FORBIDDEN"

        404:
          description: Not Found - Menu item doesn't exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 404
                message: "Menu Item ID 1 not found"
                code: "ID_NOT_FOUND"

  # ============================================
  # PATCH /items/{id}/inventory-type
  # ============================================
  /menu/items/{id}/inventory-type:
    patch:
      tags:
        - Menu Items - Stock
      summary: Configure inventory tracking type
      description: |
        Configures whether a menu item requires stock tracking or has unlimited availability.

        This endpoint is used for:
        - Initial menu item setup
        - Converting item types
        - Seasonal inventory changes
        - Business model adjustments

        **Inventory Types:**

        **TRACKED:**
        - Limited daily stock
        - Requires daily reset
        - Auto-deducts on orders
        - Can go out of stock
        - Low stock alerts enabled
        - Suitable for: Pre-prepared dishes

        **UNLIMITED:**
        - Always available
        - No stock tracking
        - No deduction on orders
        - No alerts
        - Suitable for: Bottled drinks

        **Side Effects:**
        - TRACKED → UNLIMITED: Clears stock data
        - UNLIMITED → TRACKED: Requires subsequent daily-reset

        **Required Permissions:**
        - ADMIN role only

      security:
        - BearerAuth: []

      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
          description: Menu item identifier
          example: 1

      requestBody:
        required: true
        description: Inventory type configuration
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryTypeRequest"
            examples:
              setTracked:
                summary: Configure as TRACKED with alert
                value:
                  inventoryType: "TRACKED"
                  lowStockAlert: 5

              setUnlimited:
                summary: Configure as UNLIMITED
                value:
                  inventoryType: "UNLIMITED"

              trackedHighAlert:
                summary: TRACKED with high alert threshold
                value:
                  inventoryType: "TRACKED"
                  lowStockAlert: 10

      responses:
        200:
          description: Inventory type updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MenuItemResponse"
              example:
                success: true
                message: "Inventory Type updated successfully"
                data:
                  id: 1
                  categoryId: 2
                  name: "Bandeja Paisa"
                  description: "Traditional Colombian platter"
                  price: 25000.00
                  isExtra: false
                  isAvailable: true
                  imageUrl: "https://cloudinary.com/plaet/items/bandeja-paisa.jpg"
                  inventoryType: "TRACKED"
                  stockQuantity: null
                  initialStock: null
                  lowStockAlert: 5
                  autoMarkUnavailable: true
                  createdAt: "2025-01-15T10:00:00.000Z"
                  updatedAt: "2025-10-14T15:30:00.000Z"
                  deleted: false
                  deletedAt: null

        400:
          description: Bad Request - Invalid inventory type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 400
                message: "Validation failed"
                code: "VALIDATION_ERROR"
                errors:
                  - field: "inventoryType"
                    message: "Invalid enum value. Expected 'TRACKED' | 'UNLIMITED'"

        401:
          description: Unauthorized - Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 401
                message: "Authentication required"
                code: "UNAUTHORIZED"

        403:
          description: Forbidden - User lacks ADMIN role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 403
                message: "Only administrators can configure inventory types"
                code: "FORBIDDEN"

        404:
          description: Not Found - Menu item doesn't exist
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                success: false
                status: 404
                message: "Menu Item ID 1 not found"
                code: "ID_NOT_FOUND"
